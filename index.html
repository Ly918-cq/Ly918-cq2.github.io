<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çº³ç§‘å†œå“ - å†œäº§å“åˆæ ¼è¯ç”Ÿæˆç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2E7D32',
                        secondary: '#F57C00',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .form-input { @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent; }
            .btn-primary { @apply bg-primary text-white font-medium px-6 py-3 rounded-lg hover:bg-primary/90 transition-colors; }
            .card { @apply bg-white rounded-lg shadow-md p-4 md:p-6 mb-6; }
            .certificate { @apply w-full max-w-[600px] border-2 border-primary rounded-lg p-4 sm:p-6 mx-auto bg-white; }
            .loading { @apply inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2; }
        }

        /* å¼ºåˆ¶é™åˆ¶äºŒç»´ç å°ºå¯¸ */
        #qrcode {
            width: 96px !important;
            height: 96px !important;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #qrcode img {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-primary text-white sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
            <div class="flex items-center mb-2 sm:mb-0">
                <i class="fa-solid fa-leaf text-2xl mr-2"></i>
                <span class="font-bold text-xl">çº³ç§‘å†œå“ | Natcropp</span>
            </div>
            <div class="flex items-center">
                <span class="text-sm">+86-15922933088</span>
                <span class="text-xs ml-2 bg-white/20 px-2 py-1 rounded">ä»‚æ˜­å›½é™…è´¸æ˜“</span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6 sm:py-8">
        <div class="card text-center mb-6">
            <h1 class="text-2xl font-bold text-primary mb-3">å†œäº§å“è´¨é‡å®‰å…¨æ‰¿è¯ºè¾¾æ ‡åˆæ ¼è¯</h1>
            <p class="text-gray-600 mb-4">å¡«å†™ä¿¡æ¯ï¼Œä¸€é”®ç”Ÿæˆåˆè§„åˆæ ¼è¯</p>
        </div>

        <!-- å¡«æŠ¥åŒº -->
        <div class="card" id="formSection">
            <h2 class="text-lg font-bold mb-4 text-primary border-b pb-2">ä¿¡æ¯å¡«æŠ¥</h2>
            <form id="certForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2"><h3 class="font-medium mb-3 text-secondary text-sm">ä¸€ã€ä¸»ä½“ä¿¡æ¯</h3></div>
                <div><label class="block text-gray-700 mb-2">ä¸»ä½“åç§° <span class="text-red-500">*</span></label><input type="text" id="operatorName" class="form-input" required></div>
                <div><label class="block text-gray-700 mb-2">ä¸»ä½“ç±»å‹ <span class="text-red-500">*</span></label><select id="operatorType" class="form-input" required><option value="">è¯·é€‰æ‹©</option><option value="å†œæˆ·">å†œæˆ·</option><option value="ä¼ä¸š">å†œä¸šä¼ä¸š</option><option value="åˆä½œç¤¾">åˆä½œç¤¾</option></select></div>
                <div><label class="block text-gray-700 mb-2">ç”Ÿäº§åœ°å€ <span class="text-red-500">*</span></label><input type="text" id="operatorAddress" class="form-input" required></div>
                <div><label class="block text-gray-700 mb-2">è”ç³»ç”µè¯ <span class="text-red-500">*</span></label><input type="tel" id="operatorPhone" class="form-input" required pattern="^1[3-9]\d{9}$"></div>

                <div class="md:col-span-2"><h3 class="font-medium mb-3 text-secondary text-sm">äºŒã€äº§å“ä¿¡æ¯</h3></div>
                <div><label class="block text-gray-700 mb-2">äº§å“åç§° <span class="text-red-500">*</span></label><input type="text" id="productName" class="form-input" required></div>
                <div><label class="block text-gray-700 mb-2">å“ç§</label><input type="text" id="productVariety" class="form-input"></div>
                <div><label class="block text-gray-700 mb-2">æ•°é‡/é‡é‡ <span class="text-red-500">*</span></label><input type="text" id="productQuantity" class="form-input" required></div>
                <div><label class="block text-gray-700 mb-2">æ—¥æœŸ <span class="text-red-500">*</span></label><input type="date" id="produceDate" class="form-input" required></div>

                <div class="md:col-span-2"><h3 class="font-medium mb-3 text-secondary text-sm">ä¸‰ã€æ‰¿è¯ºä¿¡æ¯</h3></div>
                <div><label class="block text-gray-700 mb-2">æ£€æµ‹ç»“æœ <span class="text-red-500">*</span></label><select id="detectResult" class="form-input" required><option value="">è¯·é€‰æ‹©</option><option value="åˆæ ¼">åˆæ ¼</option><option value="æœªæ£€æµ‹ï¼ˆæ‰¿è¯ºåˆæ ¼ï¼‰">æœªæ£€æµ‹</option></select></div>
                <div><label class="block text-gray-700 mb-2">æ‰¿è¯ºäºº <span class="text-red-500">*</span></label><input type="text" id="promisorName" class="form-input" required></div>
                
                <div class="md:col-span-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="promiseAgree" class="w-4 h-4 mr-2" required>
                        <span class="text-sm">æˆ‘æ‰¿è¯ºä»¥ä¸Šä¿¡æ¯çœŸå®æœ‰æ•ˆï¼Œæ‰¿æ‹…æ³•å¾‹è´£ä»»ã€‚</span>
                    </label>
                </div>

                <div class="md:col-span-2 flex justify-center mt-4">
                    <button type="submit" id="submitBtn" class="btn-primary w-full md:w-auto">
                        <i class="fa-solid fa-check mr-2"></i>ç”Ÿæˆåˆæ ¼è¯
                    </button>
                </div>
            </form>
        </div>

        <!-- é¢„è§ˆåŒº -->
        <div class="card hidden" id="previewSection">
            <h2 class="text-lg font-bold mb-4 text-primary border-b pb-2">åˆæ ¼è¯é¢„è§ˆ</h2>
            
            <div class="certificate mb-6" id="certificate">
                <!-- ä¼˜åŒ–åçš„å¸ƒå±€ï¼šæ ‡é¢˜å’ŒäºŒç»´ç å‚ç›´æ’åˆ— -->
                <div class="flex flex-col items-center mb-4">
                    <h2 class="text-xl font-bold text-primary mb-3">å†œäº§å“è´¨é‡å®‰å…¨æ‰¿è¯ºè¾¾æ ‡åˆæ ¼è¯</h2>
                    <div id="qrcode" class="w-24 h-24"></div>
                </div>
                
                <table class="w-full border-collapse mb-4 text-sm">
                    <tbody>
                        <tr class="border-b border-gray-200"><td class="py-2 w-1/3 font-medium">ä¸»ä½“åç§°</td><td class="py-2" id="previewOperatorName">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">ä¸»ä½“ç±»å‹</td><td class="py-2" id="previewOperatorType">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">ç”Ÿäº§åœ°å€</td><td class="py-2" id="previewOperatorAddress">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">è”ç³»ç”µè¯</td><td class="py-2" id="previewOperatorPhone">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">äº§å“åç§°</td><td class="py-2" id="previewProductName">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">å“ç§</td><td class="py-2" id="previewProductVariety">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">æ•°é‡</td><td class="py-2" id="previewProductQuantity">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">æ—¥æœŸ</td><td class="py-2" id="previewProduceDate">-</td></tr>
                        <tr class="border-b border-gray-200"><td class="py-2 font-medium">æ£€æµ‹ç»“æœ</td><td class="py-2" id="previewDetectResult">-</td></tr>
                    </tbody>
                </table>
                
                <div class="mt-4 text-sm">
                    <p class="italic">æ‰¿è¯ºäººï¼š<span id="previewPromisorName">-</span></p>
                    <p class="mt-2">æœ¬æ‰¹æ¬¡å†œäº§å“ç¬¦åˆè´¨é‡å®‰å…¨æ ‡å‡†ï¼Œæœ¬äººå¯¹çœŸå®æ€§è´Ÿè´£ã€‚</p>
                    <p class="text-right mt-3">ç”Ÿæˆæ—¶é—´ï¼š<span id="previewCreateTime">-</span></p>
                    <p class="text-right text-xs text-gray-500 mt-1">çº³ç§‘å†œå“ Â© ä»‚æ˜­å›½é™…è´¸æ˜“</p>
                </div>
            </div>

            <!-- æ–°å¢ï¼šå®Œæ•´ä¿¡æ¯å¤åˆ¶ + åŒæ­¥åˆ°å…¬ä¼—å· -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h3 class="text-sm font-medium text-primary mb-2">ğŸ“Œ åŒæ­¥ä¿¡æ¯åˆ°å…¬ä¼—å·ï¼ˆæ–¹ä¾¿æŸ¥è¯¢/ç»Ÿè®¡ï¼‰</h3>
                <textarea id="fullCertInfo" class="w-full p-2 border border-gray-200 rounded-lg text-xs mb-2" rows="6" readonly></textarea>
                <div class="flex gap-2 flex-wrap">
                    <button id="copyFullInfoBtn" class="bg-primary/80 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fa-solid fa-copy mr-1"></i> å¤åˆ¶å®Œæ•´ä¿¡æ¯
                    </button>
                    <button id="syncToWechatBtn" class="bg-secondary text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fa-brands fa-weixin mr-1"></i> åŒæ­¥åˆ°å…¬ä¼—å·
                    </button>
                </div>
            </div>

            <!-- å…¬ä¼—å·äºŒç»´ç æç¤ºåŒºï¼ˆé»˜è®¤éšè—ï¼‰ -->
            <div id="wechatSyncTip" class="hidden text-center mb-4">
                <p class="text-sm text-gray-700 mb-2">è¯·æ‰“å¼€å¾®ä¿¡ï¼Œæ‰«ç å…³æ³¨åç²˜è´´å¤åˆ¶çš„ä¿¡æ¯å‘é€</p>
                <img 
                    src="https://raw.githubusercontent.com/Ly918-cq/Ly918-cq2.github.io/main/wechat-qrcode.png.jpg"
                    class="w-40 h-40 mx-auto border border-gray-200 p-2 rounded-lg mb-2"
                    alt="çº³ç§‘å†œå“å…¬ä¼—å·äºŒç»´ç "
                >
                <p class="text-xs text-red-500">å‘é€åä½ ä¼šæ”¶åˆ°å¾®ä¿¡æ–°æ¶ˆæ¯æé†’ï¼Œå¯åœ¨åå°å¯¼å‡ºæ•°æ®</p>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center gap-3">
                <button id="exportPdfBtn" class="btn-primary w-full sm:w-auto">å¯¼å‡ºPDF</button>
                <button id="exportJpgBtn" class="bg-secondary text-white font-medium px-6 py-3 rounded-lg hover:bg-secondary/90 w-full sm:w-auto">å¯¼å‡ºJPG</button>
                <button id="backBtn" class="bg-gray-600 text-white font-medium px-6 py-3 rounded-lg hover:bg-gray-700 w-full sm:w-auto">è¿”å›ä¿®æ”¹</button>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>çº³ç§‘å†œå“ | Natcropp Â© 2026 ä»‚æ˜­å›½é™…è´¸æ˜“ï¼ˆé‡åº†ï¼‰æœ‰é™å…¬å¸</p>
        </div>
    </footer>

    <script>
        const APP_CONFIG = {
            certPrefix: 'NC',
            // ä½ çš„å…¬ä¼—å·æŸ¥è¯¢å›¾æ–‡é“¾æ¥
            wechatQueryUrl: 'https://mp.weixin.qq.com/s/ioWZPFuxKIQ0H8dJKcAK4A'
        };

        const certForm = document.getElementById('certForm');
        const formSection = document.getElementById('formSection');
        const previewSection = document.getElementById('previewSection');
        const certificate = document.getElementById('certificate');
        const fullCertInfo = document.getElementById('fullCertInfo');
        const wechatSyncTip = document.getElementById('wechatSyncTip');
        let qrCodeInstance = null;
        let currentCertId = '';
        let currentCertData = {};

        // è¡¨å•æäº¤
        certForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
            
            try {
                currentCertId = APP_CONFIG.certPrefix + Date.now();
                currentCertData = {
                    åˆæ ¼è¯ç¼–å·: currentCertId,
                    ä¸»ä½“åç§°: document.getElementById('operatorName').value,
                    ä¸»ä½“ç±»å‹: document.getElementById('operatorType').value,
                    ç”Ÿäº§åœ°å€: document.getElementById('operatorAddress').value,
                    è”ç³»ç”µè¯: document.getElementById('operatorPhone').value,
                    äº§å“åç§°: document.getElementById('productName').value,
                    å“ç§: document.getElementById('productVariety').value || 'æ— ',
                    æ•°é‡: document.getElementById('productQuantity').value,
                    æ—¥æœŸ: document.getElementById('produceDate').value ? new Date(document.getElementById('produceDate').value).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }) : '-',
                    æ£€æµ‹ç»“æœ: document.getElementById('detectResult').value,
                    æ‰¿è¯ºäºº: document.getElementById('promisorName').value,
                    ç”Ÿæˆæ—¶é—´: new Date().toLocaleString('zh-CN')
                };

                // å¡«å……é¢„è§ˆ
                Object.keys(currentCertData).forEach(key => {
                    const previewKey = 'preview' + key.charAt(0).toUpperCase() + key.slice(1);
                    const el = document.getElementById(previewKey);
                    if (el) el.textContent = currentCertData[key];
                });

                // å¡«å……å®Œæ•´ä¿¡æ¯æ–‡æœ¬æ¡†
                let infoText = '';
                for (const [key, value] of Object.entries(currentCertData)) {
                    infoText += `${key}ï¼š${value}\n`;
                }
                fullCertInfo.value = infoText;

                // ç”ŸæˆäºŒç»´ç ï¼šæŒ‡å‘æŸ¥è¯¢å›¾æ–‡é¡µ
                const qrcode = document.getElementById('qrcode');
                qrcode.innerHTML = '';
                if (typeof QRCode === 'undefined') {
                    alert('äºŒç»´ç åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                qrCodeInstance = new QRCode(qrcode, {
                    text: APP_CONFIG.wechatQueryUrl,
                    width: 96,
                    height: 96,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                formSection.classList.add('hidden');
                previewSection.classList.remove('hidden');
                previewSection.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>ç”Ÿæˆåˆæ ¼è¯';
            }
        });

        // å¤åˆ¶å®Œæ•´ä¿¡æ¯
        document.getElementById('copyFullInfoBtn').addEventListener('click', () => {
            fullCertInfo.select();
            document.execCommand('copy');
            alert('å®Œæ•´ä¿¡æ¯å·²å¤åˆ¶ï¼Œè¯·å‰å¾€å…¬ä¼—å·ç²˜è´´å‘é€ï¼');
        });

        // åŒæ­¥åˆ°å…¬ä¼—å·ï¼ˆæ˜¾ç¤ºæç¤ºï¼‰
        document.getElementById('syncToWechatBtn').addEventListener('click', () => {
            wechatSyncTip.classList.remove('hidden');
            wechatSyncTip.scrollIntoView({ behavior: 'smooth' });
            // å…ˆå¤åˆ¶ä¿¡æ¯
            fullCertInfo.select();
            document.execCommand('copy');
            alert('ä¿¡æ¯å·²å¤åˆ¶ï¼Œæ‰«ç å‘é€å³å¯ï¼');
        });

        // è¿”å›æŒ‰é’®
        document.getElementById('backBtn').addEventListener('click', () => {
            previewSection.classList.add('hidden');
            formSection.classList.remove('hidden');
            wechatSyncTip.classList.add('hidden');
        });

        // å¯¼å‡ºPDF
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            const btn = document.getElementById('exportPdfBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading"></span>å¯¼å‡ºä¸­...';
            setTimeout(() => {
                html2canvas(certificate, { scale: 3, useCORS: true }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const imgWidth = 210;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    pdf.addImage(imgData, 'JPEG', 0, (297 - imgHeight) / 2, imgWidth, imgHeight);
                    pdf.save(`åˆæ ¼è¯_${currentCertId}.pdf`);
                    btn.disabled = false; btn.textContent = 'å¯¼å‡ºPDF';
                });
            }, 500);
        });

        // å¯¼å‡ºJPG
        document.getElementById('exportJpgBtn').addEventListener('click', () => {
            const btn = document.getElementById('exportJpgBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading"></span>å¯¼å‡ºä¸­...';
            setTimeout(() => {
                html2canvas(certificate, { scale: 3, useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `åˆæ ¼è¯_${currentCertId}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                    btn.disabled = false; btn.textContent = 'å¯¼å‡ºJPG';
                });
            }, 500);
        });
    </script>
</body>
</html>
